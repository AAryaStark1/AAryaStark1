<!DOCTYPE html><html><head>
      <title>IO_URing学习笔记</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////home/lihao/.vscode-server/extensions/shd101wyy.markdown-preview-enhanced-0.8.15/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<p>本篇是对Linux中新增的IO_Uring异步机制的实现的学习笔记，IO_Uring是与Linux传统的Epoll IO多路复用的相对于的实现机制。Epoll IO多路复用机制主要用于实现Reactor事件触发模型，当监控的端口有事件触发时，一般为可读，可写事件，其中通过与Listin连接监控fd进行对比判断是否时新的连接事件，创建新的客户端fd。当是其他的可读可写事件的时候，将通过缓冲区进行正常的读写操作，send和recv都需要传递一个用户态的缓冲区用于接收、发送到socket内核缓冲区，调用内核协议栈实现数据包的发送。</p>
<p>Epoll多路复用机制一般需要搭配非阻塞的IO，解决了send和recv造成的线程阻塞问题，实现了socket端口从未就绪态到就绪的异步处理，但是本身IO处理还包括对数据缓冲区的拷贝，需要使用系统调用完成用户态到内核态的切换，这个过程依然是阻塞的，因此一般称Epoll实现的IO称为半同步的IO处理模型。并且在调用Epoll_wait进行就绪端口的返回的时候，主线程也会阻塞，直到有就绪事件发生或是达到了设定的timeout，所以epoll本身也是同步的处理模型。</p>
<p>IO_URING异步处理机制是完全异步的linux系统中处理模型，可以类比为一个线程池的处理，用户态的程序将IO请求打包发送到IOURING的任务队列中，便能够正常的返回，避免的数据拷贝的阻塞等待。IOURING中使用内核的工作队列，不断的从任务队列中获取IO请求，不断进行真正的处理，并将处理的结果发送的完成队列中。用户态的线程可以不断的从完成队列中进行收割，以数据接收为例，完成后的IO请求就已经被拷贝到用户空间中了，并可以正确的解析处理。IO_URING不仅提供了网络收发的IO处理，能够支持对文件的读取和写入，并能够取消和关闭文件描述符进行系统回收，并提供了多种高级特性实现高效的IO处理。</p>
<p><strong>一、IO_URING的基本实现</strong><br>
IO_URING的核心数据结构是两个无锁的环形数据结构io_uring_sq和io_uring_cq，分别代表着一个一个提交队列和一个完成队列。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sq</span> sq<span class="token punctuation">;</span>
	<span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_cq</span> cq<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> flags<span class="token punctuation">;</span>
	<span class="token keyword keyword-int">int</span> ring_fd<span class="token punctuation">;</span>

	<span class="token keyword keyword-unsigned">unsigned</span> features<span class="token punctuation">;</span>
	<span class="token keyword keyword-int">int</span> enter_ring_fd<span class="token punctuation">;</span>
	__u8 int_flags<span class="token punctuation">;</span>
	__u8 pad<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> pad2<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>以提交队列为例：</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sq</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>khead<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>ktail<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>kring_mask<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>kring_entries<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>kflags<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>kdropped<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>array<span class="token punctuation">;</span>
	<span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqes<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> sqe_head<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> sqe_tail<span class="token punctuation">;</span>
	size_t ring_sz<span class="token punctuation">;</span>
	<span class="token keyword keyword-void">void</span> <span class="token operator">*</span>ring_ptr<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> ring_mask<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> ring_entries<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> pad<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>sqe_head和sqe_tail分别表示队列的头尾节点，ring_entries表示队列的深度，也就是环形队列的大小，其中值得注意的是struct io_uring_sqe *sqes的数据结构，指向的是实际需要提交的IO请求。user_data用于标识提交的IO请求，相应的完成队列项中user_data会设置相同的user_data。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token punctuation">{</span>
	__u8	opcode<span class="token punctuation">;</span>		<span class="token comment">// 操作类型</span>
	__u8	flags<span class="token punctuation">;</span>		<span class="token comment">// 操作标志</span>
	__u16	ioprio<span class="token punctuation">;</span>		<span class="token comment">// I/O 优先级</span>
	__s32	fd<span class="token punctuation">;</span>		    <span class="token comment">// 文件描述符</span>
	__u64	user_data<span class="token punctuation">;</span>	<span class="token comment">// 完成时传递回的数据</span>
	<span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_cqe</span> <span class="token operator">*</span>cqes<span class="token punctuation">;</span> <span class="token comment">//完成队列</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>完成队列项中，传递在提交队列中使用的user_data，以及IO请求返回的结果，设置结果设置的Flags标志位。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_cq</span> <span class="token punctuation">{</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>khead<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> <span class="token operator">*</span>ktail<span class="token punctuation">;</span>
	<span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_cqe</span> <span class="token operator">*</span>cqes<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> ring_mask<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> ring_entries<span class="token punctuation">;</span>
	<span class="token keyword keyword-unsigned">unsigned</span> pad<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>其中完成队列项io_uring_cqe的主要实现是：</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_cqe</span> <span class="token punctuation">{</span>
	__u64	user_data<span class="token punctuation">;</span>	<span class="token comment">/* sqe-&gt;user_data value passed back */</span>
	__s32	res<span class="token punctuation">;</span>		<span class="token comment">/* result code for this event */</span>
	__u32	flags<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>获取cqe的时候调用的是cqe = &amp;ring-&gt;cq.cqes[(head &amp; mask) &lt;&lt; shift]，mask在这里是全为1的掩码，所以在完成队列和提交队列分别维持了一个io_uring_sqe和io_uring_cqe的数组。为了避免用户态和内核态的切换，IOURING通过mmap的系统调用开辟了一块用户态和内核态的共享内存，避免了每次系统调用带来的状态切换和数据拷贝带来的内存开销，其中使用传入的参数entries作为提交队列初始化的大小，完成队列一般为提交队列的两倍，一般都为2的整数次幂。</p>
<p>其中值得注意的是IO_URING使用了无锁编程的数据结构，io_uring_sq和io_uring_cq都维持了一块环形队列，通过头尾两个指针，指向需要操作的数组索引，其中用户进程想SQ提交队列的tail尾部提交SQE请求，内核线程从SQ提交队列的头部进行收割，在完成真正的IO处理之后，内核线程将完成后的结果打包成CQE提交到CQ提交队列的尾部，后续的用户程序可以不断的循环从CQ的头部收割IO请求的结果。</p>
<p>其中另一个值得注意的IOURING的实现中还包括一个重要的缓冲区io_ring_buff，在需要实施需要缓冲区的系统调用时,如recv时，通过设置SQE的flag的标志位IOSQE_BUFFER_SELECT，不需要传递用户态的缓冲区，完成系统调用后，可以通过flag中的偏置找到对应数据缓冲区，进行recv数据的接收。</p>
<p><strong>二、IOURING的高级特性</strong><br>
IOURING通过一些高级特性实现了对异步io调用的加速。主要用到的一些策略包括注册缓冲区和注册文件描述符等...<br>
1、注册缓存区，IORING_REGISTER_BUFFERS<br>
在初始化 io_uring 之后，调用 io_uring_register 函数，传递IORING_REGISTER_BUFFERS 作为操作码（opcode）。参数是一个指向 iovec 数组的指针，表示这些地址需要映射到内核。在实际操作中主要用于recv系统调用的场景，用户不需要每次都传递用户态的虚拟地址，内核在处理 IORING_REGISTER_BUFFERS 时，会提前调用 get_user_pages 来获取用户空间虚拟地址对应的物理页面。这样，内核就可以在后续的 I/O 操作中直接使用这些物理页面，使用带 FIXED 版本的 opcode，可以直接操作已经注册的缓冲区，从而避免额外的地址转换开销。<br>
2、内核的poll轮询模式，IORING_SETUP_IOPOLL<br>
内核的poll轮询模式与普通的模式相对，在中断驱动模式下，I/O 操作完成后，内核会通过硬件中断通知CPU。CPU 接收到中断后，会处理中断并完成 I/O 事件的回调，这种方法的优点是具有低cpu的占用，缺点是每一个io都需要进行中断处理，在高并发的场景下，存在一定的延迟。轮询驱动：在 IORING_SETUP_IOPOLL 模式下，内核会主动轮询 I/O 设备，检查是否有 I/O 事件发生，这种模式下内核需要不断的轮询io设备，CPU的占用会变高，但是会带来处理速度上的提升。</p>
<p>3、注册文件描述符，IORING_REGISTER_FILES<br>
对于提交到IOURING中的文件描述符，可以使用IOURING对文件描述符进行管理，这里的实现是IOURING可以开辟一块数组用于文件描述符的注册，向IOURING提交请求的时候可以携带IOSQE_FIXED_FILE的标志位，将具体的文件描述符保留在文件描述符注册表中，可以使用注册表中的索引进行具体的请求提交。这里的好处是，这个的用途是避免每次 IO 对文件做 fget/fput 操作，避免了每次的IO请求都需要去内核空间中进行查找。</p>
<p><strong>三、liburing</strong><br>
IOURING只提供了三个系统调用，分别是</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> <span class="token function">io_uring_setup</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> entries<span class="token punctuation">,</span> <span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_params</span> <span class="token operator">*</span>params<span class="token punctuation">)</span>；
</code></pre><p>entries：queue depth，表示队列深度，io_uring_params：初始化时候的参数，上述调用用于创建以个IOURING实例，返回一个文件描述符，在实例操作中，还会创建上述提到的提交队列和完成队列，以及SQE和CQE提交项和完成项数组。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> <span class="token function">io_uring_enter</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-int">int</span> fd<span class="token punctuation">,</span> u32 to_submit<span class="token punctuation">,</span> u32 min_complete<span class="token punctuation">,</span> u32 flags<span class="token punctuation">)</span>；
</code></pre><p>io_uring_enter即可以提交io，也可以来收割完成的IO，一般IO完成时内核会自动将SQE 的索引放入到CQ中，用户可以遍历CQ来处理完成的IO，IO 提交的做法是找到一个空闲的 SQE，根据请求设置 SQE，并将这个 SQE 的索引放到 SQ 中。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> <span class="token function">io_uring_register</span><span class="token punctuation">(</span><span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-int">int</span> fd<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-int">int</span> opcode<span class="token punctuation">,</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-int">int</span> nr_args<span class="token punctuation">)</span>
</code></pre><p>主要包括上述提到的缓冲区注册和文件描述符注册。</p>
<p>为了便于使用，IOURING作者还创建了LibUring这个C++库实现了对IOURING的封装。下面是一些主要使用的函数接口。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> fd <span class="token operator">=</span> <span class="token function">io_uring_queue_init_params</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">)</span>；
</code></pre><p>用于创建一个iouring的实例，handle为实际的io_uring对象，返回一个iouring的文件描述符。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> result <span class="token operator">=</span> <span class="token function">io_uring_register_ring_fd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword keyword-this">this</span><span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span>；
</code></pre><p>通过将io_uring本身注册的文件描述符中，可以实现内存mmap共享的效果，减少多线程或多进程之间的上下文切换。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> result <span class="token operator">=</span> <span class="token function">io_uring_register_iowq_aff</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword keyword-this">this</span><span class="token operator">-&gt;</span>handle<span class="token punctuation">,</span> <span class="token keyword keyword-sizeof">sizeof</span><span class="token punctuation">(</span>cpuSet<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpuSet<span class="token punctuation">)</span>；
</code></pre><p>设置iouring工作队列的CPU亲和性，允许用户指定哪些 CPU 核心将用于处理 io_uring 的工作队列，从而优化 I/O 操作的调度，减少上下文切换和缓存未命中，从而提高整体系统性能。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> <span class="token function">io_uring_register_files_sparse</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring</span> <span class="token operator">*</span>ring<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> nr<span class="token punctuation">)</span>；
<span class="token keyword keyword-int">int</span> <span class="token function">io_uring_register_file_alloc_range</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring</span> <span class="token operator">*</span>ring<span class="token punctuation">,</span><span class="token keyword keyword-unsigned">unsigned</span> off<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> len<span class="token punctuation">)</span>；
<span class="token keyword keyword-int">int</span> <span class="token function">io_uring_register_files_update</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring</span> <span class="token operator">*</span>ring<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> off<span class="token punctuation">,</span> <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-int">int</span> <span class="token operator">*</span>files<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> nr_files<span class="token punctuation">)</span>
</code></pre><p>上述的函数用于注册文件描述符，注册稀疏文件描述符，更新文件描述符。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_buf_ring</span> <span class="token operator">*</span><span class="token function">io_uring_setup_buf_ring</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring</span> <span class="token operator">*</span>ring<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-int">int</span> nentries<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> bgid<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-int">int</span> flags<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> <span class="token operator">*</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-int">int</span> result  <span class="token operator">=</span> <span class="token function">io_uring_free_buf_ring</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword keyword-this">this</span><span class="token operator">-&gt;</span>handle<span class="token punctuation">,</span> ringBufferHandle<span class="token punctuation">,</span> entries<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>上述的实现用于创建和销毁一个io_uring_buffer对象，用于iouring缓存区的注册。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">io_uring_prep_write</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqe<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> fd<span class="token punctuation">,</span>
				       <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> nbytes<span class="token punctuation">,</span>
				       __u64 offset<span class="token punctuation">)</span>
</code></pre><p>准备一个写操作。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">io_uring_prep_multishot_accept_direct</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqe<span class="token punctuation">,</span>
							 <span class="token keyword keyword-int">int</span> fd<span class="token punctuation">,</span>
							 <span class="token keyword keyword-struct">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span>
							 socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">,</span>
							 <span class="token keyword keyword-int">int</span> flags<span class="token punctuation">)</span>
</code></pre><p>接受连接操作，允许多次触发。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">io_uring_prep_read</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqe<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> fd<span class="token punctuation">,</span>
				      <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> nbytes<span class="token punctuation">,</span> __u64 offset<span class="token punctuation">)</span>
</code></pre><p>准备一个读操作。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">io_uring_prep_recv_multishot</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqe<span class="token punctuation">,</span>
						<span class="token keyword keyword-int">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span>
						size_t len<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> flags<span class="token punctuation">)</span>
</code></pre><p>准备一个接收操作，允许多次触发。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">io_uring_prep_cancel_fd</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqe<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> fd<span class="token punctuation">,</span>
					   <span class="token keyword keyword-unsigned">unsigned</span> <span class="token keyword keyword-int">int</span> flags<span class="token punctuation">)</span>
</code></pre><p>准备一个取消操作，取消对应fd上的事件。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">io_uring_prep_close_direct</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqe<span class="token punctuation">,</span>
					      <span class="token keyword keyword-unsigned">unsigned</span> file_index<span class="token punctuation">)</span>
</code></pre><p>准备一个直接关闭文件描述符的操作。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">io_uring_prep_send_zc</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_sqe</span> <span class="token operator">*</span>sqe<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> sockfd<span class="token punctuation">,</span>
					 <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-void">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> flags<span class="token punctuation">,</span>
					 <span class="token keyword keyword-unsigned">unsigned</span> zc_flags<span class="token punctuation">)</span>
</code></pre><p>准备一个零拷贝（zero-copy）发送数据操作。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token keyword keyword-int">int</span> <span class="token function">io_uring_submit_and_wait</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring</span> <span class="token operator">*</span>ring<span class="token punctuation">,</span> <span class="token keyword keyword-unsigned">unsigned</span> wait_nr<span class="token punctuation">)</span>
</code></pre><p>上述用户提交并sqe请求并等待有wait_nr个就绪事件发生</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">io_uring_for_each_cqe</span><span class="token expression"><span class="token punctuation">(</span>ring<span class="token punctuation">,</span> head<span class="token punctuation">,</span> cqe<span class="token punctuation">)</span>				</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>head <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>ring<span class="token punctuation">)</span><span class="token operator">-&gt;</span>cq<span class="token punctuation">.</span>khead<span class="token punctuation">;</span>					</span><span class="token punctuation">\</span>
	     <span class="token expression"><span class="token punctuation">(</span>cqe <span class="token operator">=</span> <span class="token punctuation">(</span>head <span class="token operator">!=</span> <span class="token function">io_uring_smp_load_acquire</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ring<span class="token punctuation">)</span><span class="token operator">-&gt;</span>cq<span class="token punctuation">.</span>ktail<span class="token punctuation">)</span> <span class="token operator">?</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token operator">&amp;</span><span class="token punctuation">(</span>ring<span class="token punctuation">)</span><span class="token operator">-&gt;</span>cq<span class="token punctuation">.</span>cqes<span class="token punctuation">[</span><span class="token function">io_uring_cqe_index</span><span class="token punctuation">(</span>ring<span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token punctuation">(</span>ring<span class="token punctuation">)</span><span class="token operator">-&gt;</span>cq<span class="token punctuation">.</span>ring_mask<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
	     <span class="token expression">head<span class="token operator">++</span><span class="token punctuation">)</span></span></span>
</code></pre><p>上述是一个宏定义，用于遍历每一个完成事件cqe，进行IO收割，并可以通过cqe来获得完成项中的结果。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>IOURINGINLINE <span class="token keyword keyword-void">void</span> <span class="token function">__io_uring_buf_ring_cq_advance</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring</span> <span class="token operator">*</span>ring<span class="token punctuation">,</span>
						  <span class="token keyword keyword-struct">struct</span> <span class="token class-name">io_uring_buf_ring</span> <span class="token operator">*</span>br<span class="token punctuation">,</span>
						  <span class="token keyword keyword-int">int</span> cq_count<span class="token punctuation">,</span> <span class="token keyword keyword-int">int</span> buf_count<span class="token punctuation">)</span>
</code></pre><p>同时推进 io_uring 的完成队列（Completion Queue, CQ）和缓冲区环（Buffer Ring）。</p>
<pre data-role="codeBlock" data-info="cpp" class="language-cpp cpp"><code>io_uring_sqe<span class="token operator">*</span> sqe <span class="token operator">=</span> <span class="token function">io_uring_get_sqe</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword keyword-this">this</span><span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span>；
</code></pre><p>用于获得可以提交的io_uring_sqe项，由于请求的提交。</p>

      </div>
      <div class="md-sidebar-toc"></div>
      <a id="sidebar-toc-btn">≡</a>
    
    
    
    
    
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  
    </body></html>
